<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kitap Ä°Ã§erik EditÃ¶rÃ¼ - CanlÄ± Ã–nizleme</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Cormorant+Garamond:wght@300;400;600;700&family=EB+Garamond:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'EB Garamond', serif;
            background: linear-gradient(135deg, #0e0a08 0%, #1a120e 100%);
            color: #e0d0b0;
            min-height: 100vh;
            padding: 20px;
            overflow: hidden;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            height: calc(100vh - 40px);
        }

        .editor-panel {
            background: rgba(26, 18, 14, 0.9);
            border: 1px solid rgba(197, 160, 89, 0.3);
            border-radius: 8px;
            padding: 30px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .preview-panel {
            background: rgba(26, 18, 14, 0.9);
            border: 1px solid rgba(197, 160, 89, 0.3);
            border-radius: 8px;
            padding: 30px;
            overflow-y: auto;
            overflow-x: auto;
            display: flex;
            flex-direction: column;
            align-items: center; /* Ã–nizlemeyi ortala */
        }

        h1 {
            font-family: 'Cinzel', serif;
            color: #c5a059;
            margin-bottom: 10px;
            font-size: 1.8rem;
        }

        h2 {
            font-family: 'Cinzel', serif;
            color: #c5a059;
            margin-bottom: 20px;
            font-size: 1.4rem;
        }

        .subtitle {
            color: #a89f91;
            margin-bottom: 20px;
            font-style: italic;
            font-size: 0.9rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #c5a059;
            font-family: 'Cinzel', serif;
            font-size: 0.9rem;
        }

        input[type="number"],
        input[type="text"],
        textarea {
            width: 100%;
            padding: 12px;
            background: rgba(14, 10, 8, 0.8);
            border: 1px solid rgba(197, 160, 89, 0.3);
            border-radius: 4px;
            color: #e0d0b0;
            font-family: 'EB Garamond', serif;
            font-size: 1rem;
        }

        input[type="range"] {
            padding: 0;
            height: 6px;
            background: rgba(197, 160, 89, 0.2);
            border-radius: 3px;
            outline: none;
            cursor: pointer;
            -webkit-appearance: none;
            appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: var(--gold-accent);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(197, 160, 89, 0.5);
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: var(--gold-accent);
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 0 10px rgba(197, 160, 89, 0.5);
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-color: #c5a059;
            box-shadow: 0 0 10px rgba(197, 160, 89, 0.2);
        }

        textarea {
            min-height: 300px;
            resize: vertical;
            line-height: 1.8;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            background: rgba(197, 160, 89, 0.2);
            border: 1px solid rgba(197, 160, 89, 0.5);
            border-radius: 4px;
            color: #c5a059;
            font-family: 'Cinzel', serif;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            min-width: 120px;
        }

        button:hover {
            background: rgba(197, 160, 89, 0.3);
            border-color: #c5a059;
            transform: translateY(-2px);
        }

        button.primary {
            background: rgba(197, 160, 89, 0.4);
        }

        .info-text {
            color: #a89f91;
            font-size: 0.85rem;
            margin-top: 8px;
            font-style: italic;
        }

        /* CanlÄ± Ã–nizleme Stilleri - styles.css'ten miras alÄ±nan */
        .live-preview {
            background-color: var(--paper-color);
            background-image: url("https://www.transparenttextures.com/patterns/paper.png");
            background-size: auto;
            padding: 0; /* Padding dinamik olarak uygulanacak */
            width: 425px; /* Tek sayfa geniÅŸliÄŸi (850px / 2 = 425px) */
            height: 620px; /* GerÃ§ek sayfa yÃ¼ksekliÄŸi */
            box-shadow: inset 0 0 20px rgba(0,0,0,0.05);
            position: relative;
            color: #2d2420;
            text-align: justify;
            margin: 0 auto; /* Ortala */
            overflow: hidden; /* TaÅŸmayÄ± Ã¶nle */
            box-sizing: border-box;
        }

        .live-preview .text-page {
            color: #2d2420;
            line-height: 1.5;
            font-size: 0.9rem;
            text-align: justify;
        }

        .live-preview .chapter-head {
            text-align: center;
            margin-bottom: 15px;
            margin-top: 5px;
        }

        .live-preview .chapter-num {
            font-family: var(--font-cinzel);
            color: #8a7a70;
            font-size: 0.75rem;
            letter-spacing: 1.5px;
        }

        .live-preview .chapter-name {
            display: block;
            font-family: var(--font-cinzel);
            font-size: 1.4rem;
            font-weight: bold;
            color: #4a3b32;
            margin-top: 3px;
        }

        .live-preview .text-body {
            margin-bottom: 20px;
        }

        .live-preview .text-body p {
            margin-bottom: 1rem;
            text-indent: 1.5em;
        }

        .live-preview .text-body p:first-of-type {
            text-indent: 0;
        }

        /* BÃ¼yÃ¼k harf efekti sadece baÅŸlÄ±klÄ± sayfalarda */
        .live-preview .text-page.has-chapter .text-body p:first-of-type::first-letter {
            float: left;
            font-size: 2.5rem;
            line-height: 0.75;
            padding-right: 8px;
            font-family: var(--font-cinzel);
            color: var(--gold-accent);
        }

        .live-preview .page-footer {
            position: absolute;
            bottom: 20px;
            left: 0;
            width: 100%;
            text-align: center;
            font-family: var(--font-cinzel);
            color: #888;
            font-size: 0.85rem;
        }

        .live-preview h4 {
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
            font-family: var(--font-cinzel);
            color: #4a3b32;
            font-size: 1.1rem;
        }

        .live-preview strong {
            font-weight: 600;
        }

        .live-preview .page-image-full {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
            overflow: hidden;
            z-index: 1;
        }

        .live-preview .full-page-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .page-selector {
            margin-bottom: 20px;
        }

        .page-selector {
            position: relative;
        }

        .last-page-info {
            font-size: 0.75rem;
            color: #a89f91;
            font-weight: normal;
            font-style: italic;
            margin-left: 8px;
            font-family: 'EB Garamond', serif;
        }

        .custom-select-wrapper {
            position: relative;
        }

        .page-selector select {
            width: 100%;
            padding: 12px;
            background: rgba(14, 10, 8, 0.8);
            border: 1px solid rgba(197, 160, 89, 0.3);
            border-radius: 4px;
            color: #e0d0b0;
            font-family: 'Cinzel', serif;
            font-size: 0.9rem;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23c5a059' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 40px;
        }

        .page-selector select:focus {
            outline: none;
            border-color: #c5a059;
            box-shadow: 0 0 10px rgba(197, 160, 89, 0.2);
        }

        /* Dropdown aÃ§Ä±ldÄ±ÄŸÄ±nda kaydÄ±rma iÃ§in - tarayÄ±cÄ± dropdown'Ä± iÃ§in */
        .page-selector select option {
            background: rgba(14, 10, 8, 0.95);
            color: #e0d0b0;
            padding: 10px;
        }

        /* Firefox iÃ§in select dropdown kaydÄ±rma */
        @-moz-document url-prefix() {
            .page-selector select {
                max-height: 300px;
            }
        }

        /* Select elementine size ekleyerek kaydÄ±rma saÄŸlama (geÃ§ici olarak) */
        .page-selector select[size] {
            max-height: 300px;
            overflow-y: auto;
        }

        /* Scrollbar stilleri (Chrome, Edge, Safari) */
        .editor-panel::-webkit-scrollbar,
        .preview-panel::-webkit-scrollbar {
            width: 10px;
        }

        .editor-panel::-webkit-scrollbar-track,
        .preview-panel::-webkit-scrollbar-track {
            background: rgba(14, 10, 8, 0.5);
            border-radius: 5px;
        }

        .editor-panel::-webkit-scrollbar-thumb,
        .preview-panel::-webkit-scrollbar-thumb {
            background: rgba(197, 160, 89, 0.4);
            border-radius: 5px;
            border: 2px solid rgba(14, 10, 8, 0.5);
        }

        .editor-panel::-webkit-scrollbar-thumb:hover,
        .preview-panel::-webkit-scrollbar-thumb:hover {
            background: rgba(197, 160, 89, 0.6);
        }

        .empty-preview {
            text-align: center;
            padding: 100px 20px;
            color: #a89f91;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sol Panel: EditÃ¶r -->
        <div class="editor-panel">
            <h1>Kitap Ä°Ã§erik EditÃ¶rÃ¼</h1>
            <p class="subtitle">Ä°Ã§erik girerken saÄŸ tarafta canlÄ± Ã¶nizleme gÃ¶rÃ¼necektir</p>

            <form id="page-form">
                <div class="page-selector">
                    <label for="page-select">
                        Sayfa SeÃ§ / Yeni Ekle
                        <span id="last-page-info" class="last-page-info"></span>
                    </label>
                    <div class="custom-select-wrapper">
                        <select id="page-select" size="1">
                            <option value="new">+ Yeni Sayfa Ekle</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="page-number">Sayfa NumarasÄ±</label>
                    <input type="number" id="page-number" min="1" required>
                    <p class="info-text">Not: Kapaklar (1-2 ve son 2 sayfa) dÃ¼zenlenemez</p>
                </div>

                <div class="form-group">
                    <label for="chapter-title">BÃ¶lÃ¼m BaÅŸlÄ±ÄŸÄ± (Opsiyonel)</label>
                    <input type="text" id="chapter-title" placeholder="Ã–rn: BÃ–LÃœM I - Demleme Ã‚lemi">
                </div>

                <div class="form-group">
                    <label for="page-image">Resim (Opsiyonel)</label>
                    <div style="display: flex; gap: 10px; align-items: flex-end;">
                        <div style="flex: 1;">
                            <input type="text" id="page-image" placeholder="Ã–rn: images/foto1.jpg veya https://example.com/resim.jpg">
                        </div>
                        <div>
                            <input type="file" id="image-file-input" accept="image/*" style="display: none;">
                            <button type="button" id="btn-select-image" style="padding: 12px 20px; background: rgba(197, 160, 89, 0.2); border: 1px solid rgba(197, 160, 89, 0.4); border-radius: 4px; color: var(--gold-accent); cursor: pointer; font-family: 'Cinzel', serif; font-size: 0.9rem; transition: all 0.3s ease;">Dosya SeÃ§</button>
                        </div>
                    </div>
                    <p class="info-text" style="margin-top: 5px;">Yerel dosya iÃ§in: images/foto1.jpg | DÄ±ÅŸ URL iÃ§in: https://example.com/resim.jpg</p>
                    <p class="info-text" id="image-file-name" style="margin-top: 5px; color: #4ade80; display: none;"></p>
                </div>

                <div class="form-group">
                    <label for="page-content">Sayfa Ä°Ã§eriÄŸi</label>
                    <textarea id="page-content" placeholder="Sayfa iÃ§eriÄŸini buraya yazÄ±n. HTML etiketleri kullanabilirsiniz (Ã¶rn: &lt;p&gt;, &lt;h4&gt;, &lt;strong&gt;)."></textarea>
                    <p class="info-text">HTML etiketleri desteklenir: &lt;p&gt;, &lt;h4&gt;, &lt;strong&gt;, &lt;em&gt; vb.</p>
                    <p class="info-text" id="word-count" style="margin-top: 5px;">Kelime sayÄ±sÄ±: 0 (Hedef: ~225 kelime/sayfa)</p>
                </div>

                <div class="form-group">
                    <label>Sayfa AyarlarÄ±</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <div>
                            <label for="font-size" style="font-size: 0.85rem; margin-bottom: 5px;">Font Boyutu:</label>
                            <input type="range" id="font-size" min="0.7" max="1.2" step="0.05" value="0.75" style="width: 100%;">
                            <span id="font-size-value" style="font-size: 0.8rem; color: #a89f91;">0.75rem</span>
                        </div>
                        <div>
                            <label for="line-height" style="font-size: 0.85rem; margin-bottom: 5px;">SatÄ±r AralÄ±ÄŸÄ±:</label>
                            <input type="range" id="line-height" min="1.2" max="2.0" step="0.1" value="1.4" style="width: 100%;">
                            <span id="line-height-value" style="font-size: 0.8rem; color: #a89f91;">1.4</span>
                        </div>
                        <div>
                            <label for="chapter-size" style="font-size: 0.85rem; margin-bottom: 5px;">BÃ¶lÃ¼m BaÅŸlÄ±ÄŸÄ±:</label>
                            <input type="range" id="chapter-size" min="1.0" max="2.5" step="0.1" value="1.2" style="width: 100%;">
                            <span id="chapter-size-value" style="font-size: 0.8rem; color: #a89f91;">1.2rem</span>
                        </div>
                        <div>
                            <label for="padding-size" style="font-size: 0.85rem; margin-bottom: 5px;">Sayfa Padding:</label>
                            <input type="range" id="padding-size" min="20" max="60" step="5" value="40" style="width: 100%;">
                            <span id="padding-size-value" style="font-size: 0.8rem; color: #a89f91;">40px</span>
                        </div>
                    </div>
                </div>

                <div class="form-group" id="image-settings-group" style="display: none;">
                    <label>Resim AyarlarÄ± (Ã–nizlemede sÃ¼rÃ¼kleyerek dÃ¼zenleyebilirsiniz)</label>
                    <p class="info-text" style="margin-top: 5px; font-size: 0.85rem; color: #a89f91;">
                        ðŸ’¡ Ä°pucu: SaÄŸ taraftaki Ã¶nizlemede resme tÄ±klayÄ±n, kÃ¶ÅŸelerden boyutlandÄ±rÄ±n ve sÃ¼rÃ¼kleyerek konumlandÄ±rÄ±n.
                    </p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <div>
                            <label for="image-width" style="font-size: 0.85rem; margin-bottom: 5px;">GeniÅŸlik (%):</label>
                            <input type="range" id="image-width" min="30" max="100" step="5" value="100" style="width: 100%;">
                            <span id="image-width-value" style="font-size: 0.8rem; color: #a89f91;">100%</span>
                        </div>
                        <div>
                            <label for="image-max-height" style="font-size: 0.85rem; margin-bottom: 5px;">Maks. YÃ¼kseklik (px):</label>
                            <input type="range" id="image-max-height" min="100" max="500" step="50" value="300" style="width: 100%;">
                            <span id="image-max-height-value" style="font-size: 0.8rem; color: #a89f91;">300px</span>
                        </div>
                        <div>
                            <label for="image-align" style="font-size: 0.85rem; margin-bottom: 5px;">Hizalama:</label>
                            <select id="image-align" style="width: 100%; padding: 8px; background: rgba(14, 10, 8, 0.8); border: 1px solid rgba(197, 160, 89, 0.3); border-radius: 4px; color: #e0d0b0; font-family: 'Cinzel', serif; font-size: 0.9rem;">
                                <option value="center">Ortala</option>
                                <option value="left">Sol</option>
                                <option value="right">SaÄŸ</option>
                            </select>
                        </div>
                        <div>
                            <label for="image-margin" style="font-size: 0.85rem; margin-bottom: 5px;">Ãœst/Alt BoÅŸluk (px):</label>
                            <input type="range" id="image-margin" min="0" max="50" step="5" value="15" style="width: 100%;">
                            <span id="image-margin-value" style="font-size: 0.8rem; color: #a89f91;">15px</span>
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button type="submit" id="btn-save" class="primary">Kaydet</button>
                    <button type="button" id="btn-delete">Sil</button>
                    <button type="button" id="btn-export">Bu SayfayÄ± JSON Ä°ndir</button>
                    <button type="button" id="btn-export-all">TÃ¼m SayfalarÄ± Ä°ndir</button>
                    <button type="button" id="btn-clear-storage" style="background: rgba(239, 68, 68, 0.2); border-color: rgba(239, 68, 68, 0.5); color: #f87171;">localStorage Temizle</button>
                </div>
                
            </form>
        </div>

        <!-- SaÄŸ Panel: CanlÄ± Ã–nizleme -->
        <div class="preview-panel">
            <h2>CanlÄ± Ã–nizleme</h2>
            <p class="subtitle">YazdÄ±ÄŸÄ±nÄ±z iÃ§erik burada gerÃ§ek zamanlÄ± olarak gÃ¶rÃ¼necektir</p>
            
            <div class="live-preview" id="live-preview">
                <div class="empty-preview">
                    Ä°Ã§erik girmeye baÅŸladÄ±ÄŸÄ±nÄ±zda Ã¶nizleme burada gÃ¶rÃ¼necektir...
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>
        $(document).ready(function() {
            const STORAGE_KEY = 'bookContent';
            
            // Sayfa listesini yÃ¼kle
            loadPageSelector();
            
            // Ä°lk yÃ¼klemede en son sayfa bilgisini gÃ¶ster
            const initialData = getStoredData();
            if (initialData.pages && initialData.pages.length > 0) {
                const maxPage = Math.max(...initialData.pages.map(p => p.pageNumber));
                updateLastPageInfo(maxPage);
            } else {
                updateLastPageInfo(0);
            }
            
            // Select dropdown kaydÄ±rma iÃ§in
            const $pageSelect = $('#page-select');
            
            // Select aÃ§Ä±ldÄ±ÄŸÄ±nda (focus) size'Ä± artÄ±r
            $pageSelect.on('focus', function() {
                const optionCount = $(this).find('option').length;
                // Maksimum 10 seÃ§enek gÃ¶ster, geri kalanÄ± kaydÄ±rma ile eriÅŸilebilir
                $(this).attr('size', Math.min(optionCount, 10));
            });
            
            // Select kapandÄ±ÄŸÄ±nda (blur) size'Ä± tekrar 1 yap
            $pageSelect.on('blur', function() {
                $(this).attr('size', 1);
            });
            
            // SeÃ§im yapÄ±ldÄ±ÄŸÄ±nda da size'Ä± 1 yap
            $pageSelect.on('change', function() {
                $(this).attr('size', 1);
                $(this).blur(); // Focus'u kaldÄ±r
            });
            
            // Sayfa ayarlarÄ± iÃ§in varsayÄ±lan deÄŸerler
            let pageSettings = {
                fontSize: 0.75,
                lineHeight: 1.4,
                chapterSize: 1.2,
                paddingSize: 40
            };

            // Resim ayarlarÄ± iÃ§in varsayÄ±lan deÄŸerler
            let imageSettings = {
                width: 100,
                maxHeight: 300,
                align: 'center',
                margin: 15
            };

            // Slider event handler'larÄ±
            $('#font-size').on('input', function() {
                pageSettings.fontSize = parseFloat($(this).val());
                $('#font-size-value').text(pageSettings.fontSize + 'rem');
                updateLivePreview();
            });

            $('#line-height').on('input', function() {
                pageSettings.lineHeight = parseFloat($(this).val());
                $('#line-height-value').text(pageSettings.lineHeight);
                updateLivePreview();
            });

            $('#chapter-size').on('input', function() {
                pageSettings.chapterSize = parseFloat($(this).val());
                $('#chapter-size-value').text(pageSettings.chapterSize + 'rem');
                updateLivePreview();
            });

            $('#padding-size').on('input', function() {
                pageSettings.paddingSize = parseInt($(this).val());
                $('#padding-size-value').text(pageSettings.paddingSize + 'px');
                updateLivePreview();
            });

            // Kelime sayacÄ± iÃ§in event listener
            $('#page-content').on('input keyup', function() {
                updateWordCount();
                updateLivePreview();
            });

            // CanlÄ± Ã¶nizleme iÃ§in event listener'lar
            $('#chapter-title').on('input keyup', function() {
                updateLivePreview();
            });

            $('#page-image').on('input keyup', function() {
                const imageUrl = $(this).val().trim();
                // Resim ayarlarÄ± grubunu gizle (artÄ±k tam sayfa resim gÃ¶sterimi kullanÄ±lÄ±yor)
                $('#image-settings-group').hide();
                updateLivePreview();
            });

            // Resim ayarlarÄ± event handler'larÄ±
            $('#image-width').on('input', function() {
                imageSettings.width = parseInt($(this).val());
                $('#image-width-value').text(imageSettings.width + '%');
                updateLivePreview();
            });

            $('#image-max-height').on('input', function() {
                imageSettings.maxHeight = parseInt($(this).val());
                $('#image-max-height-value').text(imageSettings.maxHeight + 'px');
                updateLivePreview();
            });

            $('#image-align').on('change', function() {
                imageSettings.align = $(this).val();
                updateLivePreview();
            });

            $('#image-margin').on('input', function() {
                imageSettings.margin = parseInt($(this).val());
                $('#image-margin-value').text(imageSettings.margin + 'px');
                updateLivePreview();
            });

            // Dosya seÃ§ butonu
            $('#btn-select-image').click(function() {
                $('#image-file-input').click();
            });

            // Dosya seÃ§ildiÄŸinde
            $('#image-file-input').on('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Dosya boyutu kontrolÃ¼ (5MB limit)
                    const maxFileSize = 5 * 1024 * 1024; // 5MB
                    if (file.size > maxFileSize) {
                        alert('UYARI: Dosya Ã§ok bÃ¼yÃ¼k! (Maksimum: 5MB)\n\n' +
                              'SeÃ§ilen dosya: ' + (file.size / 1024 / 1024).toFixed(2) + ' MB\n\n' +
                              'Not: BÃ¼yÃ¼k resimler localStorage kotasÄ±nÄ± aÅŸabilir. LÃ¼tfen:\n' +
                              '1. Resmi kÃ¼Ã§Ã¼ltÃ¼n veya\n' +
                              '2. Resmi bir sunucuya yÃ¼kleyip URL kullanÄ±n');
                        $(this).val(''); // Dosya seÃ§imini temizle
                        return;
                    }
                    
                    // DosyayÄ± oku ve base64 data URL'e Ã§evir
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const dataUrl = e.target.result;
                        $('#page-image').val(dataUrl);
                        $('#image-file-name').text(`SeÃ§ilen dosya: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`).show();
                        // Resim ayarlarÄ± grubunu gizle (artÄ±k tam sayfa resim gÃ¶sterimi kullanÄ±lÄ±yor)
                        $('#image-settings-group').hide();
                        updateLivePreview();
                        console.log('Resim yÃ¼klendi, imageUrl uzunluÄŸu:', dataUrl.length);
                        
                        // Base64 resim uyarÄ±sÄ±
                        if (dataUrl.length > 500000) { // ~500KB
                            alert('UYARI: Bu resim base64 formatÄ±nda Ã§ok bÃ¼yÃ¼k!\n\n' +
                                  'Kaydetme sÄ±rasÄ±nda localStorage kotasÄ± aÅŸÄ±labilir.\n' +
                                  'Ã–neri: Resmi bir sunucuya yÃ¼kleyip URL kullanÄ±n.');
                        }
                    };
                    reader.onerror = function() {
                        alert('Dosya okunurken bir hata oluÅŸtu!');
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Sayfa numarasÄ± deÄŸiÅŸtiÄŸinde Ã¶nizlemeyi gÃ¼ncelle
            $('#page-number').on('input', function() {
                updateLivePreview();
            });

            // Kelime sayacÄ± fonksiyonu
            function updateWordCount() {
                const content = $('#page-content').val();
                const text = content.replace(/<[^>]*>/g, ''); // HTML etiketlerini kaldÄ±r
                const words = text.trim().split(/\s+/).filter(word => word.length > 0);
                const wordCount = words.length;
                $('#word-count').text(`Kelime sayÄ±sÄ±: ${wordCount} (Hedef: ~225 kelime/sayfa)`);
                
                // Renk deÄŸiÅŸtir
                const $wordCount = $('#word-count');
                if (wordCount >= 200 && wordCount <= 225) {
                    $wordCount.css('color', '#4ade80'); // YeÅŸil - ideal aralÄ±k
                } else if (wordCount < 200) {
                    $wordCount.css('color', '#fbbf24'); // SarÄ± - az
                } else {
                    $wordCount.css('color', '#f87171'); // KÄ±rmÄ±zÄ± - Ã§ok fazla (225'ten fazla)
                }
            }

            // Sayfa seÃ§ici deÄŸiÅŸtiÄŸinde
            $('#page-select').on('change', function() {
                const value = $(this).val();
                if (value === 'new') {
                    // Yeni sayfa iÃ§in formu temizle
                    $('#page-form')[0].reset();
                    $('#page-select').val('new');
                    updateLivePreview();
                } else {
                    // Mevcut sayfayÄ± yÃ¼kle
                    loadPage(parseInt(value));
                }
            });

            // Form submit
            $('#page-form').on('submit', function(e) {
                e.preventDefault();
                savePage();
            });

            // Sil butonu
            $('#btn-delete').on('click', function() {
                const pageNum = parseInt($('#page-number').val());
                if (pageNum && confirm('Bu sayfayÄ± silmek istediÄŸinize emin misiniz?')) {
                    deletePage(pageNum);
                }
            });

            // Bu sayfayÄ± JSON olarak indir
            $('#btn-export').on('click', function() {
                const pageNum = parseInt($('#page-number').val());
                const chapterTitle = $('#chapter-title').val().trim();
                const content = $('#page-content').val().trim();
                const imageUrl = $('#page-image').val().trim();

                if (!pageNum || (!content && !imageUrl)) {
                    alert('Ã–nce sayfa numarasÄ± ve iÃ§erik veya resim girin!');
                    return;
                }

                const pageData = {
                    pageNumber: pageNum,
                    chapterTitle: chapterTitle,
                    content: content,
                    imageUrl: imageUrl || null,
                    pageSettings: {
                        fontSize: pageSettings.fontSize,
                        lineHeight: pageSettings.lineHeight,
                        chapterSize: pageSettings.chapterSize,
                        paddingSize: pageSettings.paddingSize
                    },
                    imageSettings: imageSettings
                };

                // JSON'u indir
                const jsonString = JSON.stringify(pageData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `sayfa${pageNum}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert(`Sayfa ${pageNum} JSON olarak indirildi!`);
            });

            // TÃ¼m sayfalarÄ± ayrÄ± ayrÄ± indir
            $('#btn-export-all').on('click', function() {
                const data = getStoredData();
                
                if (!data.pages || data.pages.length === 0) {
                    alert('Ä°ndirilecek sayfa yok!');
                    return;
                }

                // Åžu anki form verilerini de dahil et
                const currentPageNum = parseInt($('#page-number').val());
                const currentChapterTitle = $('#chapter-title').val().trim();
                const currentContent = $('#page-content').val().trim();
                const currentImageUrl = $('#page-image').val().trim();

                if (currentPageNum && (currentContent || currentImageUrl)) {
                    const existingIndex = data.pages.findIndex(p => p.pageNumber == currentPageNum);
                    const pageData = {
                        pageNumber: currentPageNum,
                        chapterTitle: currentChapterTitle,
                        content: currentContent,
                        imageUrl: currentImageUrl || null,
                        pageSettings: {
                            fontSize: pageSettings.fontSize,
                            lineHeight: pageSettings.lineHeight,
                            chapterSize: pageSettings.chapterSize,
                            paddingSize: pageSettings.paddingSize
                        },
                        imageSettings: imageSettings
                    };

                    if (existingIndex >= 0) {
                        data.pages[existingIndex] = pageData;
                    } else {
                        data.pages.push(pageData);
                    }
                }

                // Her sayfayÄ± ayrÄ± dosya olarak indir
                data.pages.sort((a, b) => a.pageNumber - b.pageNumber);
                
                data.pages.forEach((page, index) => {
                    setTimeout(() => {
                        const jsonString = JSON.stringify(page, null, 2);
                        const blob = new Blob([jsonString], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `sayfa${page.pageNumber}.json`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    }, index * 200); // Her dosya arasÄ±nda 200ms bekle
                });

                setTimeout(() => {
                    alert(`${data.pages.length} sayfa JSON olarak indirildi!`);
                }, data.pages.length * 200);
            });

            // CanlÄ± Ã¶nizlemeyi gÃ¼ncelle
            function updateLivePreview() {
                const pageNum = $('#page-number').val();
                const chapterTitle = $('#chapter-title').val().trim();
                const content = $('#page-content').val().trim();
                const imageUrl = $('#page-image').val().trim();

                const $preview = $('#live-preview');
                
                if (!content && !chapterTitle && !imageUrl) {
                    $preview.html('<div class="empty-preview">Ä°Ã§erik girmeye baÅŸladÄ±ÄŸÄ±nÄ±zda Ã¶nizleme burada gÃ¶rÃ¼necektir...</div>');
                    $preview.css('padding', '0');
                    return;
                }

                // Ã–nizleme alanÄ±na padding uygula (gerÃ§ek sayfa gibi)
                $preview.css({
                    'padding': pageSettings.paddingSize + 'px',
                    'box-sizing': 'border-box'
                });
                
                // BaÅŸlÄ±k var mÄ± kontrol et (bÃ¼yÃ¼k harf efekti iÃ§in)
                const hasChapterTitle = chapterTitle && chapterTitle.trim();
                const textPageClass = hasChapterTitle ? 'text-page has-chapter' : 'text-page';
                
                let previewHTML = `<div class="${textPageClass}" style="font-size: ${pageSettings.fontSize}rem; line-height: ${pageSettings.lineHeight}; width: 100%; height: 100%; box-sizing: border-box; overflow: hidden;">`;
                
                // BÃ¶lÃ¼m baÅŸlÄ±ÄŸÄ±
                if (chapterTitle) {
                    const chapterParts = chapterTitle.split(' - ');
                    let chapterNum = '';
                    let chapterName = '';
                    
                    if (chapterParts.length > 1) {
                        chapterNum = chapterParts[0].trim();
                        chapterName = chapterParts.slice(1).join(' - ').trim();
                    } else {
                        chapterName = chapterTitle.trim();
                    }
                    
                    previewHTML += '<div class="chapter-head">';
                    if (chapterNum) {
                        previewHTML += `<span class="chapter-num">${escapeHtml(chapterNum)}</span>`;
                    }
                    if (chapterName) {
                        previewHTML += `<span class="chapter-name" style="font-size: ${pageSettings.chapterSize}rem; font-weight: bold;">${escapeHtml(chapterName)}</span>`;
                    }
                    previewHTML += '</div>';
                }

                // Resim (tam sayfa olarak gÃ¶ster)
                if (imageUrl) {
                    // Tam sayfa boyutunda gÃ¶ster
                    previewHTML += `<div class="page-image-full"><img src="${imageUrl}" alt="Sayfa resmi" class="full-page-image" onerror="this.style.display='none'; console.error('Resim yÃ¼klenemedi');"></div>`;
                }

                // Ä°Ã§erik
                if (content) {
                    previewHTML += '<div class="text-body">';
                    // HTML iÃ§eriÄŸi doÄŸrudan ekle (gÃ¼venlik iÃ§in basit bir escape yapÄ±yoruz ama HTML'e izin veriyoruz)
                    previewHTML += content;
                    previewHTML += '</div>';
                }

                // Sayfa numarasÄ±
                if (pageNum) {
                    previewHTML += `<span class="page-footer">${escapeHtml(pageNum)}</span>`;
                }

                previewHTML += '</div>';
                $preview.html(previewHTML);
            }

            // HTML escape (basit)
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // Sayfa yÃ¼kle
            function loadPage(pageNum) {
                const data = getStoredData();
                const page = data.pages.find(p => p.pageNumber == pageNum);
                
                if (page) {
                    $('#page-number').val(page.pageNumber);
                    $('#chapter-title').val(page.chapterTitle || '');
                    $('#page-image').val(page.imageUrl || '');
                    $('#page-content').val(page.content || '');
                    $('#page-select').val(pageNum);
                    
                    // Sayfa ayarlarÄ±nÄ± yÃ¼kle (varsa)
                    if (page.pageSettings) {
                        pageSettings.fontSize = page.pageSettings.fontSize || 0.75;
                        pageSettings.lineHeight = page.pageSettings.lineHeight || 1.4;
                        pageSettings.chapterSize = page.pageSettings.chapterSize || 1.2;
                        pageSettings.paddingSize = page.pageSettings.paddingSize || 40;
                        
                        // Slider deÄŸerlerini gÃ¼ncelle
                        $('#font-size').val(pageSettings.fontSize);
                        $('#line-height').val(pageSettings.lineHeight);
                        $('#chapter-size').val(pageSettings.chapterSize);
                        $('#padding-size').val(pageSettings.paddingSize);
                        
                        // Label deÄŸerlerini gÃ¼ncelle
                        $('#font-size-value').text(pageSettings.fontSize + 'rem');
                        $('#line-height-value').text(pageSettings.lineHeight);
                        $('#chapter-size-value').text(pageSettings.chapterSize + 'rem');
                        $('#padding-size-value').text(pageSettings.paddingSize + 'px');
                    }
                    
                    updateWordCount();
                    updateLivePreview();
                }
            }

            // Ä°lk kelime sayacÄ±nÄ± gÃ¼ncelle
            updateWordCount();

            // Sayfa kaydet
            function savePage() {
                const pageNum = parseInt($('#page-number').val());
                const chapterTitle = $('#chapter-title').val().trim();
                const content = $('#page-content').val().trim();
                const imageUrl = $('#page-image').val().trim();

                // Sayfa numarasÄ± kontrolÃ¼
                if (!pageNum || pageNum < 1 || isNaN(pageNum)) {
                    alert('GeÃ§erli bir sayfa numarasÄ± girin!');
                    $('#page-number').focus();
                    return;
                }

                // Ä°Ã§erik veya resim kontrolÃ¼
                if (!content && !imageUrl) {
                    alert('Sayfa iÃ§eriÄŸi veya resim eklenmelidir!');
                    return;
                }

                // Resim URL kontrolÃ¼ (boÅŸ string deÄŸil, gerÃ§ekten bir deÄŸer var mÄ±)
                const finalImageUrl = imageUrl && imageUrl.length > 0 ? imageUrl : null;

                let data = getStoredData();
                
                // Sayfa var mÄ± kontrol et
                const existingIndex = data.pages.findIndex(p => p.pageNumber == pageNum);
                
                const pageData = {
                    pageNumber: pageNum,
                    chapterTitle: chapterTitle || '',
                    content: content || '',
                    imageUrl: finalImageUrl,
                    pageSettings: {
                        fontSize: pageSettings.fontSize,
                        lineHeight: pageSettings.lineHeight,
                        chapterSize: pageSettings.chapterSize,
                        paddingSize: pageSettings.paddingSize
                    },
                    imageSettings: imageSettings
                };

                if (existingIndex >= 0) {
                    data.pages[existingIndex] = pageData;
                } else {
                    data.pages.push(pageData);
                }

                // Sayfa numarasÄ±na gÃ¶re sÄ±rala
                data.pages.sort((a, b) => a.pageNumber - b.pageNumber);

                // Base64 resimleri tespit et ve temizle (localStorage kotasÄ± iÃ§in)
                let hasBase64Images = false;
                data.pages.forEach(page => {
                    if (page.imageUrl && page.imageUrl.startsWith('data:image')) {
                        hasBase64Images = true;
                        // Base64 resimleri localStorage'a kaydetme - sadece uyarÄ± ver
                        page.imageUrl = null; // Base64 resmi temizle
                    }
                });

                // Veri boyutunu kontrol et
                const dataString = JSON.stringify(data);
                const dataSize = new Blob([dataString]).size;
                const maxSize = 4 * 1024 * 1024; // 4MB (localStorage genelde 5-10MB, gÃ¼venli limit)

                if (dataSize > maxSize) {
                    alert('UYARI: Veri Ã§ok bÃ¼yÃ¼k! BazÄ± sayfalarÄ± silmeniz veya iÃ§erikleri kÄ±saltmanÄ±z gerekebilir.\n\n' +
                          'Mevcut boyut: ' + (dataSize / 1024 / 1024).toFixed(2) + ' MB\n' +
                          'Ã–nerilen limit: 4 MB\n\n' +
                          'Not: Base64 formatÄ±ndaki resimler otomatik olarak kaldÄ±rÄ±ldÄ±. LÃ¼tfen resimler iÃ§in URL kullanÄ±n.');
                }

                if (hasBase64Images) {
                    const confirmSave = confirm('UYARI: Base64 formatÄ±ndaki resimler localStorage\'a kaydedilemez (kota aÅŸÄ±mÄ±).\n\n' +
                                              'Resimler temizlendi. Devam etmek istiyor musunuz?\n\n' +
                                              'Not: Resimler iÃ§in URL kullanmanÄ±z Ã¶nerilir.');
                    if (!confirmSave) {
                        return; // KullanÄ±cÄ± iptal etti
                    }
                }

                try {
                    localStorage.setItem(STORAGE_KEY, dataString);
                    console.log('Sayfa kaydedildi:', pageData);
                    console.log('Veri boyutu:', (dataSize / 1024).toFixed(2), 'KB');
                    alert('Sayfa baÅŸarÄ±yla kaydedildi!');
                    loadPageSelector();
                    $('#page-select').val(pageNum);
                } catch (e) {
                    console.error('Kaydetme hatasÄ±:', e);
                    if (e.name === 'QuotaExceededError' || e.message.includes('quota')) {
                        alert('HATA: localStorage kotasÄ± aÅŸÄ±ldÄ±!\n\n' +
                              'Ã‡Ã¶zÃ¼m Ã¶nerileri:\n' +
                              '1. BazÄ± sayfalarÄ± silin\n' +
                              '2. Ä°Ã§erikleri kÄ±saltÄ±n\n' +
                              '3. Base64 resimler yerine URL kullanÄ±n\n' +
                              '4. TÃ¼m sayfalarÄ± JSON olarak indirip localStorage\'Ä± temizleyin');
                    } else {
                        alert('Sayfa kaydedilirken bir hata oluÅŸtu! Hata: ' + e.message);
                    }
                }
            }

            // Sayfa sil
            function deletePage(pageNum) {
                let data = getStoredData();
                data.pages = data.pages.filter(p => p.pageNumber != pageNum);
                
                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                    loadPageSelector();
                    
                    // Formu temizle
                    $('#page-form')[0].reset();
                    $('#page-select').val('new');
                    updateLivePreview();
                    alert('Sayfa baÅŸarÄ±yla silindi!');
                } catch (e) {
                    console.error('Silme hatasÄ±:', e);
                    if (e.name === 'QuotaExceededError' || e.message.includes('quota')) {
                        alert('HATA: localStorage kotasÄ± aÅŸÄ±ldÄ±! LÃ¼tfen tarayÄ±cÄ± ayarlarÄ±ndan localStorage\'Ä± temizleyin.');
                    } else {
                        alert('Sayfa silinirken bir hata oluÅŸtu! Hata: ' + e.message);
                    }
                }
            }

            // Sayfa seÃ§iciyi yÃ¼kle
            function loadPageSelector() {
                const data = getStoredData();
                const $select = $('#page-select');
                
                // "Yeni Sayfa Ekle" seÃ§eneÄŸini koru
                $select.html('<option value="new">+ Yeni Sayfa Ekle</option>');
                
                let maxPageNumber = 0;
                
                if (data.pages && data.pages.length > 0) {
                    data.pages.sort((a, b) => a.pageNumber - b.pageNumber);
                    data.pages.forEach(page => {
                        const title = page.chapterTitle || `Sayfa ${page.pageNumber}`;
                        $select.append(`<option value="${page.pageNumber}">Sayfa ${page.pageNumber} - ${title}</option>`);
                        // En yÃ¼ksek sayfa numarasÄ±nÄ± bul
                        if (page.pageNumber > maxPageNumber) {
                            maxPageNumber = page.pageNumber;
                        }
                    });
                }
                
                // En son sayfa bilgisini gÃ¼ncelle
                updateLastPageInfo(maxPageNumber);
            }
            
            // En son sayfa bilgisini gÃ¼ncelle
            function updateLastPageInfo(maxPageNumber) {
                const $lastPageInfo = $('#last-page-info');
                if (maxPageNumber > 0) {
                    $lastPageInfo.text(`(Son: ${maxPageNumber})`);
                } else {
                    $lastPageInfo.text('(HenÃ¼z sayfa yok)');
                }
            }

            // JSON Ä°ndir
            function exportToJSON() {
                const data = getStoredData();
                
                // Åžu anki form verilerini de dahil et (kaydedilmemiÅŸ olsa bile)
                const currentPageNum = parseInt($('#page-number').val());
                const currentChapterTitle = $('#chapter-title').val().trim();
                const currentContent = $('#page-content').val().trim();
                const currentImageUrl = $('#page-image').val().trim();

                if (currentPageNum && (currentContent || currentImageUrl)) {
                    // Mevcut sayfayÄ± gÃ¼ncelle veya ekle
                    const existingIndex = data.pages.findIndex(p => p.pageNumber == currentPageNum);
                    const pageData = {
                        pageNumber: currentPageNum,
                        chapterTitle: currentChapterTitle,
                        content: currentContent,
                        imageUrl: currentImageUrl || null,
                        pageSettings: {
                            fontSize: pageSettings.fontSize,
                            lineHeight: pageSettings.lineHeight,
                            chapterSize: pageSettings.chapterSize,
                            paddingSize: pageSettings.paddingSize
                        }
                    };

                    if (existingIndex >= 0) {
                        data.pages[existingIndex] = pageData;
                    } else {
                        data.pages.push(pageData);
                    }

                    // SÄ±rala
                    data.pages.sort((a, b) => a.pageNumber - b.pageNumber);
                }

                // JSON'u indir
                const jsonString = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'bookContent.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert('JSON dosyasÄ± indirildi!');
            }

            // localStorage'dan veri al
            function getStoredData() {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (stored) {
                    return JSON.parse(stored);
                }
                return { pages: [] };
            }

            // localStorage temizle butonu
            $('#btn-clear-storage').on('click', function() {
                if (confirm('UYARI: TÃ¼m kaydedilmiÅŸ sayfalar silinecek!\n\n' +
                           'Ã–nce tÃ¼m sayfalarÄ± JSON olarak indirmeniz Ã¶nerilir.\n\n' +
                           'Devam etmek istiyor musunuz?')) {
                    localStorage.removeItem(STORAGE_KEY);
                    alert('localStorage temizlendi! Sayfa yenileniyor...');
                    location.reload();
                }
            });
        });
    </script>
</body>
</html>
